â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                            â•‘
â•‘          VINCULACIÃ“N MÃ“VILES â†” EQUIPOS GPS                                â•‘
â•‘                                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

================================================================================
DESCRIPCIÃ“N
================================================================================

Sistema de vinculaciÃ³n entre MÃ³viles (vehÃ­culos) y Equipos GPS.

CAMPO DE VINCULACIÃ“N:
  moviles.gps_id  â†”  equipos_gps.imei

FUNCIONAMIENTO:
  - Un mÃ³vil puede tener UN equipo GPS asignado (o ninguno)
  - El campo gps_id del mÃ³vil guarda el IMEI del equipo asignado
  - Solo se muestran equipos con estado 'inactivo' (sin asignar)
  - Al asignar un equipo, se guarda su IMEI en gps_id

================================================================================
BACKEND - API
================================================================================

1. ENDPOINT NUEVO: Equipos Sin Asignar
   
   GET /api/equipos/sin_asignar/
   
   Retorna equipos con estado='inactivo' que NO estÃ¡n asignados a ningÃºn mÃ³vil
   (no aparecen en moviles.gps_id)
   
   RESPUESTA:
   ```json
   [
     {
       "id": 1,
       "imei": "123456789012345",
       "numero_serie": "SN001",
       "marca": "Teltonika",
       "modelo": "FMB920",
       "estado": "inactivo",
       "fecha_instalacion": null,
       "created_at": "2025-10-08T...",
       "updated_at": "2025-10-08T...",
       "movil_info": null
     }
   ]
   ```

2. SERIALIZER MOVIL ACTUALIZADO:
   
   Ahora incluye campo calculado 'equipo_gps_info' que muestra:
   - IMEI del equipo
   - Marca y modelo
   - NÃºmero de serie
   - Estado
   
   EJEMPLO:
   ```json
   {
     "id": 1,
     "patente": "ABC123",
     "gps_id": "123456789012345",
     "equipo_gps_info": {
       "id": 1,
       "imei": "123456789012345",
       "marca": "Teltonika",
       "modelo": "FMB920",
       "numero_serie": "SN001",
       "estado": "activo"
     }
   }
   ```

3. SERIALIZER EQUIPO ACTUALIZADO:
   
   Ahora 'movil_info' busca en la tabla moviles por gps_id:
   
   EJEMPLO:
   ```json
   {
     "id": 1,
     "imei": "123456789012345",
     "estado": "activo",
     "movil_info": {
       "id": 1,
       "patente": "ABC123",
       "alias": "CamiÃ³n 1"
     }
   }
   ```

================================================================================
FRONTEND - MÃ“VILES
================================================================================

1. FORMULARIO DE MÃ“VIL:
   
   Nuevo campo: "Equipo GPS" (select/combo)
   
   OPCIONES:
   - "Sin asignar" (value="")
   - Lista de equipos inactivos disponibles
   - Si estÃ¡ editando y tiene uno asignado, se muestra aunque no estÃ© disponible
   
   FORMATO:
   "123456789012345 - Teltonika FMB920"

2. FUNCIÃ“N: cargarEquiposDisponibles()
   
   Se ejecuta al abrir el modal de crear/editar mÃ³vil
   
   COMPORTAMIENTO:
   - Llama a /api/equipos/sin_asignar/
   - Puebla el select con los equipos disponibles
   - Si el mÃ³vil tiene un equipo asignado, lo agrega a la lista
     aunque no estÃ© en los disponibles

3. FUNCIÃ“N: guardarMovil()
   
   El campo gps_id se envÃ­a al backend con el IMEI seleccionado
   o null si no hay selecciÃ³n

================================================================================
FLUJO DE ASIGNACIÃ“N
================================================================================

ESCENARIO 1: Asignar equipo a mÃ³vil nuevo

1. Usuario crea nuevo mÃ³vil
2. Selecciona equipo GPS del combo (solo muestra inactivos sin asignar)
3. Al guardar, se guarda el IMEI en moviles.gps_id
4. El equipo ahora aparece como "asignado" en la lista de equipos

ESCENARIO 2: Cambiar equipo de un mÃ³vil

1. Usuario edita mÃ³vil existente
2. Ve el equipo actual asignado (si tiene)
3. Puede:
   a) Mantenerlo (no cambia nada)
   b) Cambiarlo por otro disponible
   c) Quitarlo (seleccionar "Sin asignar")
4. Al guardar, se actualiza moviles.gps_id

ESCENARIO 3: Quitar equipo de un mÃ³vil

1. Usuario edita mÃ³vil
2. Selecciona "Sin asignar"
3. Al guardar, gps_id se establece en NULL
4. El equipo queda disponible para otros mÃ³viles

================================================================================
CAMBIOS DE ESTADO
================================================================================

IMPORTANTE:
El estado del equipo NO se cambia automÃ¡ticamente al asignarlo.

RECOMENDACIÃ“N FUTURA:
Implementar lÃ³gica que:
1. Al asignar equipo â†’ cambiar estado a 'activo'
2. Al quitar equipo â†’ cambiar estado a 'inactivo'

Por ahora es MANUAL:
- Asignar el equipo en el mÃ³vil
- Luego ir a Equipos y cambiar su estado manualmente

================================================================================
VALIDACIONES
================================================================================

BACKEND:
âœ“ gps_id es NULL-able (puede estar vacÃ­o)
âœ“ No hay constraint de unicidad (varios mÃ³viles podrÃ­an tener el mismo gps_id)
  NOTA: Esto podrÃ­a ser un problema. Considera agregar constraint UNIQUE.

FRONTEND:
âœ“ Solo muestra equipos inactivos sin asignar
âœ“ Permite seleccionar "Sin asignar"
âœ“ Mantiene el equipo actual al editar (aunque no estÃ© disponible)

================================================================================
ARCHIVOS MODIFICADOS
================================================================================

BACKEND:
  gps/views.py
  â””â”€ EquipoViewSet.sin_asignar()     âœ“ Endpoint para equipos disponibles
  
  gps/serializers.py
  â””â”€ MovilSerializer                  âœ“ Campo equipo_gps_info
  â””â”€ EquipoSerializer                 âœ“ Campo movil_info actualizado

FRONTEND:
  templates/moviles/index.html
  â””â”€ Campo select gps-id              âœ“ Combo de equipos
  
  static/js/moviles.js
  â””â”€ cargarEquiposDisponibles()       âœ“ Carga equipos sin asignar
  â””â”€ mostrarFormularioMovil()         âœ“ Actualizada (async)

================================================================================
USO DEL SISTEMA
================================================================================

1. CREAR EQUIPO GPS:
   - Ir a /equipos/
   - Crear equipo con IMEI
   - Estado: Inactivo
   - Guardar

2. ASIGNAR A MÃ“VIL:
   - Ir a /moviles/
   - Crear o editar mÃ³vil
   - En "Equipo GPS" seleccionar el equipo
   - Guardar

3. VER ASIGNACIÃ“N:
   - En lista de mÃ³viles: columna GPS ID
   - En lista de equipos: columna "MÃ³vil Asignado"

4. DESASIGNAR:
   - Editar mÃ³vil
   - Seleccionar "Sin asignar"
   - Guardar

================================================================================
MEJORAS FUTURAS
================================================================================

â˜ Cambio automÃ¡tico de estado del equipo al asignar/desasignar
â˜ Constraint UNIQUE en moviles.gps_id para evitar duplicados
â˜ ValidaciÃ³n que impida asignar un equipo ya asignado
â˜ Historial de asignaciones (quiÃ©n tuvo quÃ© equipo y cuÃ¡ndo)
â˜ Fecha de instalaciÃ³n/desinstalaciÃ³n automÃ¡tica
â˜ Dashboard de equipos (cuÃ¡ntos asignados, disponibles, etc.)
â˜ Filtro en mÃ³viles por "Con/Sin equipo GPS"

================================================================================

âœ… VinculaciÃ³n MÃ³viles â†” Equipos GPS implementada!

ğŸ”— Campo: moviles.gps_id â†” equipos_gps.imei
ğŸ“Š Endpoint: GET /api/equipos/sin_asignar/
ğŸ¨ Select dinÃ¡mico en formulario de mÃ³viles
âœ… Solo muestra equipos inactivos disponibles

Reinicia el servidor y prueba asignar un equipo a un mÃ³vil!

================================================================================
